<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
    <link href="/assets/app.css" rel="stylesheet"/>
    <title>Products</title>
</head>
<body class="bg-light" data-page="product_list">
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-0"><i class="fa-solid fa-boxes-stacked me-2"></i>Products</h1>
            <div class="text-muted small">HTML page backed by JSON API</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-outline-secondary btn-sm" data-route="example.users.list.page" href="#">
                <i class="fa-solid fa-users me-1"></i>Users
            </a>
            <a class="btn btn-outline-secondary btn-sm" data-route="example.products.create.page" href="#">
                <i class="fa-solid fa-circle-plus me-1"></i>New product
            </a>
            <a class="btn btn-outline-secondary btn-sm" data-route="example.products.api.read.all" href="#">
                <i class="fa-solid fa-code me-1"></i>List API (JSON)
            </a>
            <a class="btn btn-outline-secondary btn-sm" data-route="example.routes" href="#">
                <i class="fa-solid fa-route me-1"></i>Routes (JSON)
            </a>
            <a class="btn btn-outline-secondary btn-sm" data-route="example.logout" href="#">
                <i class="fa-solid fa-right-from-bracket me-1"></i>Logout
            </a>
        </div>
    </div>

    <div class="alert alert-info py-2" id="status">Loading...</div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label mb-1" for="productFilterName">Name</label>
                    <input class="form-control" id="productFilterName" placeholder="Filter by name" type="text"/>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label mb-1" for="productFilterCategory">Category</label>
                    <select class="form-select" id="productFilterCategory"></select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label mb-1" for="productFilterCurrency">Currency</label>
                    <select class="form-select" id="productFilterCurrency"></select>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <ul class="list-group" id="productList"></ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script type="text/javascript">window.melodyRoutes = JSON.parse('{{routes_json}}');</script>
<script src="/assets/app.js" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(() => {
        const list = $('#productList');
        if (0 === list.length) {
            return;
        }

        const filterName = $('#productFilterName');
        const filterCategory = $('#productFilterCategory');
        const filterCurrency = $('#productFilterCurrency');

        let cachedProducts = [];
        let cachedCategories = [];
        let cachedCurrencies = [];

        const buildOption = (value, label) => {
            const optionElement = $('<option/>');
            optionElement.attr('value', String(value ?? '').trim());
            optionElement.text(String(label ?? '').trim());
            return optionElement;
        };

        const populateFilterSelect = (selectElement, options, valueKey, labelKey) => {
            const element = $(selectElement);
            element.empty();

            element.append(buildOption('', 'All'));

            for (const item of (Array.isArray(options) ? options : [])) {
                const value = String(item?.[valueKey] ?? '').trim();
                const label = String(item?.[labelKey] ?? '').trim();
                if ('' === value) {
                    continue;
                }
                element.append(buildOption(value, label));
            }
        };

        const getFilteredProducts = () => {
            const nameValue = String(filterName.val() ?? '').trim().toLowerCase();
            const categoryValue = String(filterCategory.val() ?? '').trim();
            const currencyValue = String(filterCurrency.val() ?? '').trim();

            return cachedProducts.filter((product) => {
                const productName = String(product?.name ?? '').trim().toLowerCase();
                const productCategoryId = String(product?.categoryId ?? '').trim();
                const productCurrencyId = String(product?.currencyId ?? '').trim();

                if ('' !== nameValue && false === productName.includes(nameValue)) {
                    return false;
                }
                if ('' !== categoryValue && categoryValue !== productCategoryId) {
                    return false;
                }
                if ('' !== currencyValue && currencyValue !== productCurrencyId) {
                    return false;
                }

                return true;
            });
        };

        const render = () => {
            const currencyCodeById = {};
            for (const currency of (Array.isArray(cachedCurrencies) ? cachedCurrencies : [])) {
                const currencyId = String(currency?.id ?? '').trim();
                if ('' === currencyId) {
                    continue;
                }
                currencyCodeById[currencyId] = String(currency?.code ?? '').trim();
            }

            const categoryNameById = {};
            for (const category of (Array.isArray(cachedCategories) ? cachedCategories : [])) {
                const categoryId = String(category?.id ?? '').trim();
                if ('' === categoryId) {
                    continue;
                }
                categoryNameById[categoryId] = String(category?.name ?? '').trim();
            }

            const products = getFilteredProducts();

            list.empty();

            if (0 === products.length) {
                const li = $('<li/>');
                li.addClass('list-group-item');
                li.text('No products found.');
                list.append(li);
                return;
            }

            for (const item of products) {
                const currencyCode = String(currencyCodeById[String(item.currencyId ?? '').trim()] ?? '').trim();
                const categoryName = String(categoryNameById[String(item.categoryId ?? '').trim()] ?? '').trim();

                const price = `${Number(item.price ?? 0).toFixed(2)} ${currencyCode}`;

                const link = $('<a/>');
                link.attr(
                    'href',
                    window.melodyExample.routing.route(
                        'example.products.update.page',
                        {
                            id: item.id
                        }
                    )
                );
                link.text(`${item.name} (${item.description})`);

                const right = $('<div/>');

                if ('' !== categoryName) {
                    const badgeCategory = $('<span/>');
                    badgeCategory.addClass('badge text-bg-light border ms-2');
                    badgeCategory.text(categoryName);
                    right.append(badgeCategory);
                }

                const badgePrice = $('<span/>');
                badgePrice.addClass('badge text-bg-primary ms-2');
                badgePrice.text(price);

                const badgeStock = $('<span/>');
                badgeStock.addClass('badge text-bg-secondary ms-2');
                badgeStock.text(`stock: ${Number(item.stock ?? 0)}`);

                right.append(badgePrice);
                right.append(badgeStock);

                const li = $('<li/>');
                li.addClass('list-group-item d-flex justify-content-between align-items-center');
                li.append(link);
                li.append(right);

                list.append(li);
            }
        };

        const load = async () => {
            window.melodyExample.ui.setStatus('Loading products...');

            try {
                const categoriesResult = await window.melodyExample.http.getJson(
                    window.melodyExample.routing.route('example.categories.api.read.all')
                );
                const currenciesResult = await window.melodyExample.http.getJson(
                    window.melodyExample.routing.route('example.currencies.api.read.all')
                );
                const productsResult = await window.melodyExample.http.getJson(
                    window.melodyExample.routing.route('example.products.api.read.all')
                );

                cachedCategories = categoriesResult?.payload ?? [];
                cachedCurrencies = currenciesResult?.payload ?? [];
                cachedProducts = productsResult?.payload ?? [];

                populateFilterSelect(filterCategory, cachedCategories, 'id', 'name');
                populateFilterSelect(filterCurrency, cachedCurrencies, 'id', 'code');

                render();
                window.melodyExample.ui.setStatus('OK');
            } catch (err) {
                window.melodyExample.ui.setStatus(String(err?.message ?? err), 'danger');
            }
        };

        let filterTimeout = null;
        const scheduleRender = () => {
            if (null != filterTimeout) {
                window.clearTimeout(filterTimeout);
            }
            filterTimeout = window.setTimeout(() => {
                render();
            }, 150);
        };

        filterName.on('input', scheduleRender);
        filterCategory.on('change', scheduleRender);
        filterCurrency.on('change', scheduleRender);

        void load();
    });</script>
</body>
</html>
